<!DOCTYPE html>
<html>
<head><title>DB Bridge Storage</title></head>
<body>
    Hello Wolrd ðŸ˜¤
    <script>
        const DB_NAME = 'DomainStatusDB';
        const STORE_NAME = 'entries';

        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            }
        };

        window.addEventListener('message', async (event) => {
            const { type, id, data, requestId } = event.data;
            const db = request.result;

            if (type === 'GET_DATA') {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const getReq = store.get(id);
                getReq.onsuccess = () => {
                    event.source.postMessage({ 
                        type: 'DATA_RESPONSE', 
                        id, 
                        value: getReq.result, 
                        requestId 
                    }, event.origin);
                };
            }

            if (type === 'SAVE_DATA') {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.put({ id, ...data, updatedAt: Date.now() });
                tx.oncomplete = () => {
                    event.source.postMessage({ type: 'SAVE_SUCCESS', id, requestId }, event.origin);
                };
            }

            if (type === 'EXPORT_ALL') {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const allData = await new Promise(res => {
                    tx.objectStore(STORE_NAME).getAll().onsuccess = (e) => res(e.target.result);
                });
                event.source.postMessage({ type: 'EXPORT_RESPONSE', data: allData, requestId }, event.origin);
            }
        });
    </script>
</body>
</html>
