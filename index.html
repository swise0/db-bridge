<!DOCTYPE html>
<html>
<head><title>ðŸ˜¤DB Bridge Storage</title></head>
<body>
    <script>
        const DB_NAME = 'DomainStatusDB';
        const STORE_NAME = 'entries';
        let db = null;

        // Initialize Database
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => {
            const database = e.target.result;
            if (!database.objectStoreNames.contains(STORE_NAME)) {
                database.createObjectStore(STORE_NAME, { keyPath: 'id' });
            }
        };

        request.onsuccess = (e) => {
            db = e.target.result;
            // Tell the parent we are ready
            window.parent.postMessage({ type: 'BRIDGE_READY' }, "*");
        };

        window.addEventListener('message', async (event) => {
            if (!db) return; // Ignore messages until DB is ready
            const { type, id, data, requestId } = event.data;

            if (type === 'GET_DATA') {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const getReq = store.get(id);
                getReq.onsuccess = () => {
                    event.source.postMessage({ type: 'DATA_RESPONSE', value: getReq.result, requestId }, event.origin);
                };
            }

            if (type === 'SAVE_DATA') {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.put({ id, ...data, updatedAt: Date.now() });
                tx.oncomplete = () => {
                    event.source.postMessage({ type: 'SAVE_SUCCESS', requestId }, event.origin);
                };
            }

            if (type === 'EXPORT_ALL') {
                const tx = db.transaction(STORE_NAME, 'readonly');
                tx.objectStore(STORE_NAME).getAll().onsuccess = (e) => {
                    event.source.postMessage({ type: 'EXPORT_RESPONSE', data: e.target.result, requestId }, event.origin);
                };
            }
        });
    </script>
</body>
</html>
